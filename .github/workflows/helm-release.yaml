name: Helm Charts

on:
    workflow_dispatch:
    push:
        branches:
        - main
        paths:
        - 'charts/**'

jobs:
  get-charts:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.get_all_charts.outputs.charts }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: "🔄 Checkout repo"
        uses: actions/checkout@v5

      - name: "Get all charts"
        id: get_all_charts
        run: |
          CHART_NAMES=$(find charts -maxdepth 2 -name "Chart.yaml" | sed 's/charts\///' | sed 's/\/Chart.yaml//' | sed 's/.*/"&"/' | tr '\n' ',' | sed 's/,$//')
          echo "charts=[$CHART_NAMES]" >> $GITHUB_OUTPUT

  release:
    runs-on: ubuntu-latest
    needs: get-charts
    strategy:
      matrix:
        chart: ${{ fromJson(needs.get-charts.outputs.charts) }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: "🔄 Checkout repo"
        uses: actions/checkout@v5

      - name: "⎈ Set up Helm"
        uses: d3adb5/helm-unittest-action@v2
        with:
          helm-version: '3.10.0'
          github-token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: "🔍 Lint chart ${{ matrix.chart }}"
        run: helm lint charts/${{ matrix.chart }}

      - name: "🧪 Run helm unittest on chart ${{ matrix.chart }}"
        run: helm unittest charts/${{ matrix.chart }}
      
      - name: "🏷️ Chart Version | homelab/${{ matrix.chart }}"
        id: chart_version
        run: echo "version=$(helm show chart charts/${{ matrix.chart }} | grep '^version:' | awk '{print $2}')" >> $GITHUB_ENV

      - name: "🚀 Push Chart | homelab/${{ matrix.chart }}"
        uses: appany/helm-oci-chart-releaser@v0.5.0
        with:
          name: ${{ matrix.chart }}
          repository: josimar-silva/homelab
          tag: ${{ env.version }}
          path: charts/${{ matrix.chart }}
          registry: ghcr.io
          registry_username: ${{ secrets.REGISTRY_USERNAME }}
          registry_password: ${{ secrets.REGISTRY_PASSWORD }}
          update_dependencies: 'false'
