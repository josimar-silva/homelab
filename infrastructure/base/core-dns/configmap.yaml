apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    # Stub zone: forward all *.from-gondor.com queries to PiHole.
    # This makes local A records managed in PiHole (e.g. saruman.from-gondor.com -> 192.168.68.106)
    # resolvable from within pods without routing ALL DNS through PiHole.
    # PiHole endpoints: primary LoadBalancer 192.168.68.201, replica-01 192.168.68.116,
    # replica-02 192.168.68.111. All listen on port 53 (TCP and UDP).
    from-gondor.com:53 {
        errors
        log . {
            class error
            class denial
        }
        cache {
            success 9984 300          # Cache positive answers for 5 min (matches PiHole default TTL)
            denial 9984 30            # Cache NXDOMAIN for 30s
        }
        # Forward to all three PiHole instances in priority order.
        # sequential: tries primary first, fails over to replicas only on error/timeout.
        forward . 192.168.68.201 192.168.68.116 192.168.68.111 {
            max_concurrent 1000
            force_tcp                 # TCP for reliability; PiHole supports TCP on port 53
            expire 10s
            policy sequential
            health_check 5s
        }
        reload
    }

    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        log . {
            class error
        }
        prometheus :9153

        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }

        # TCP forwarding to prevent UDP packet loss
        forward . 1.1.1.1 8.8.8.8 {
            max_concurrent 1000
            force_tcp                 # Use TCP for reliability
            expire 30s
            policy sequential         # Try 1.1.1.1 first, then 8.8.8.8
        }

        # Enable cache for all zones
        cache 30 {
            success 9984 30           # Cache successful responses
            denial 9984 5             # Cache NXDOMAIN
        }

        loop
        reload
        loadbalance
    }
