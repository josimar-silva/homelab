apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        log . {
            class error
        }
        prometheus :9153

        kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            ttl 30
        }

        # TCP forwarding to prevent UDP packet loss
        forward . 1.1.1.1 8.8.8.8 {
            max_concurrent 1000
            force_tcp                 # Use TCP for reliability
            expire 30s
            policy sequential         # Try 1.1.1.1 first, then 8.8.8.8
        }

        # Enable cache for all zones
        cache 30 {
            success 9984 30           # Cache successful responses
            denial 9984 5             # Cache NXDOMAIN
        }

        loop
        reload
        loadbalance
    }
