apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-local-dns
  namespace: kube-system
  labels:
    app.kubernetes.io/name: node-local-dns
    app.kubernetes.io/component: dns
    k8s-app: node-local-dns
spec:
  updateStrategy:
    rollingUpdate:
      maxUnavailable: 1
    type: RollingUpdate
  selector:
    matchLabels:
      k8s-app: node-local-dns
  template:
    metadata:
      labels:
        k8s-app: node-local-dns
    spec:
      priorityClassName: system-node-critical
      serviceAccountName: node-local-dns
      hostNetwork: true
      dnsPolicy: Default
      tolerations:
      - key: "CriticalAddonsOnly"
        operator: "Exists"
      - effect: "NoExecute"
        operator: "Exists"
      - effect: "NoSchedule"
        operator: "Exists"
      containers:
      - name: node-cache
        image: registry.k8s.io/dns/k8s-dns-node-cache:1.23.1
        resources:
          requests:
            cpu: 25m
            memory: 25Mi
          limits:
            cpu: 100m
            memory: 50Mi
        args:
        - -localip
        - "169.254.20.10"
        - -conf
        - /etc/coredns/Corefile
        - -upstreamsvc
        - kube-dns
        - -health-port
        - "8080"
        securityContext:
          # NodeLocal DNS requires privilege escalation for network interface creation
          # and iptables manipulation. This is standard for network infrastructure pods.
          allowPrivilegeEscalation: true
          # Must run as root for low-level network operations (interface creation, iptables)
          runAsNonRoot: false
          runAsUser: 0
          readOnlyRootFilesystem: false
          capabilities:
            # Principle of least privilege: drop all, add only required capabilities
            drop:
            - ALL
            add:
            - NET_ADMIN          # Required: Create network interfaces & manipulate iptables
            - NET_BIND_SERVICE   # Required: Bind to privileged port 53
          # Maintain security: restrict syscalls to secure profile
          seccompProfile:
            type: RuntimeDefault
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9253
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            host: 169.254.20.10
            path: /health
            port: 8080
          initialDelaySeconds: 60
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            host: 169.254.20.10
            path: /health
            port: 8080
          initialDelaySeconds: 10
          timeoutSeconds: 5
        volumeMounts:
        - mountPath: /run/xtables.lock
          name: xtables-lock
          readOnly: false
        - name: config-volume
          mountPath: /etc/coredns
          readOnly: true
        - name: kube-dns-config
          mountPath: /etc/kube-dns
          readOnly: true
        - name: cache-volume
          mountPath: /tmp
      volumes:
      - name: xtables-lock
        hostPath:
          path: /run/xtables.lock
          type: FileOrCreate
      - name: config-volume
        configMap:
          name: node-local-dns
          items:
          - key: Corefile
            path: Corefile
      - name: kube-dns-config
        configMap:
          name: kube-dns
          optional: true
      - name: cache-volume
        emptyDir: {}
